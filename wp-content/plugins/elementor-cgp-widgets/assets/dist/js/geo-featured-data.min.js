class GeoFeaturedDataHandler extends elementorModules.frontend.handlers.Base{getDefaultSettings(){return{selectors:{wrapper:".geo-featured-data",loader:".geo-featured-data__loader",results:".geo-featured-data__results"}}}getDefaultElements(){const e=this.getSettings("selectors");return{$wrapper:this.$element.find(e.wrapper),$loader:this.$element.find(e.loader),$results:this.$element.find(e.results)}}bindEvents(){this.elements.$results.on("click",".geo-featured-data-card__view-more-button",this.onViewMoreButtonClick.bind(this)),this.elements.$results.on("click",".geo-featured-data-card__keyword-expander",this.onKeywordExpanderButtonClick.bind(this))}onViewMoreButtonClick(e){let t=jQuery(e.currentTarget);t.parent().find(".hidden, .ellipsis").toggle(),t.hasClass("clicked")?t.html(this.labels[this.lang].viewMore).removeClass("clicked"):t.html(this.labels[this.lang].showLess).addClass("clicked")}onKeywordExpanderButtonClick(e){let t=jQuery(e.currentTarget);t.toggleClass("open"),t.parent().find(".geo-featured-data-card__keywords-inner").slideToggle(),t.hasClass("open")?t.attr("aria-label",this.labels[this.lang].showLess):t.attr("aria-label",this.labels[this.lang].viewMore)}onInit(){super.onInit(),this.theme=this.elements.$wrapper.data("theme"),this.lang=this.elements.$wrapper.data("lang"),this.type=this.elements.$wrapper.data("type"),this.maxItems=this.elements.$wrapper.data("max-items"),this.labels={en:{keywordsTitle:"Related keywords",leafletAttribution:"© His Majesty the King in Right of Canada, as represented by the Minister of Natural Resources Canada, 2022",errorMessage:"We're sorry, something went wrong, please refresh the page.",organization:"Organization:",published:"Published:",showLess:"Show Less",viewMore:"View More",viewRecord:"View Record"},fr:{keywordsTitle:"Sujets connexes",leafletAttribution:"© Sa Majesté le Roi du chef du Canada, représenté par le ministre de Ressources naturelles Canada, 2022",errorMessage:"Nous sommes désolés, quelque chose s'est mal passé. Veuillez rafraîchir la page",organization:"Organisation :",published:"Publié :",showLess:"Montrer moins",viewMore:"Voir plus",viewRecord:"Afficher l'enregistrement"}},this.fetchFeaturedData()}fetchFeaturedData(){let e=geo.geocoreApiUrl;e+="/"+this.type+"?lang="+this.lang,this.theme&&(e+="&theme="+this.theme),console.log(e),fetch(e).then(e=>e.json()).then(e=>{let t=e.Items;t=t.slice(0,this.maxItems),this.elements.$loader.hide(),t.length&&t.forEach(e=>{this.renderRecord(e),this.initializeGeoviewMap(e)})}).catch(e=>{this.elements.$loader.hide(),this.renderErrorMessage(),console.warn(this.labels[this.lang].errorMessage,e)})}renderRecord(e){let t=geo.appUrl+"/result?id="+e.id+"&lang="+this.lang,a=this.getKeywordsHtml(e.keywords),s=e.description.replaceAll("\\n"," "),r=`\n\t\t\t<div class="geo-featured-data-card">\n\t\t\t\t<div class="geo-featured-data-card__map">\n\t\t\t\t\t<div class="geo-featured-data-card__map-inner">\n\t\t\t\t\t\t<div id="map-${e.id}" class="geo-featured-data-card__geoview-map"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="geo-featured-data-card__content">\n\t\t\t\t\t<h3 class="geo-featured-data-card__title">\n\t\t\t\t\t\t<a href="${t}">${e.title}</a>\n\t\t\t\t\t</h3>\n\t\t\t\t\t<div class="geo-featured-data-card__description">${s}</div>\n\t\t\t\t\t<div class="geo-featured-data-card__meta">\n\t\t\t\t\t\t<div class="geo-featured-data-card__published-date"><strong>${this.labels[this.lang].published}</strong> ${e.published}</div>\n\t\t\t\t\t\t<div class="geo-featured-data-card__organization"><strong>${this.labels[this.lang].organization}</strong> ${e.organisation}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="geo-featured-data-card__keywords">\n\t\t\t\t\t<strong>${this.labels[this.lang].keywordsTitle}:</strong>\n\t\t\t\t\t<button class="geo-featured-data-card__keyword-expander" type="button" aria-label="${this.labels[this.lang].viewMore}"><i class="fa fa-chevron-down" aria-hidden="true"></i></button>\n\t\t\t\t\t<div class="geo-featured-data-card__keywords-inner">${a}</div>\n\t\t\t\t</div>\n\t\t\t</div>`;this.elements.$results.append(r)}getKeywordsHtml(e){let t="",a=1,s=geo.appUrl+"?lang="+this.lang+"&keyword=",r=e.split(",").map(e=>e.trim()).filter(e=>"null"!=e);if(r.forEach(e=>{let r=s+encodeURIComponent(e.toLowerCase());t+=a>6?`<span class="hidden"><a class="geo-featured-data-card__keyword" href="${r}">${e}</a>,</span> `:`<a class="geo-featured-data-card__keyword" href="${r}">${e}</a>, `,a++}),t=r.length>6?t.substring(0,t.length-9)+"</span>":t.substring(0,t.length-2),r.length>6){let e=this.labels[this.lang].viewMore;t+=`<span class="ellipsis">&hellip;</span><button class="geo-featured-data-card__view-more-button">${e}</button>`}return t}initializeLeafletMap(e){let t="map-"+e.id,a=JSON.parse(e.coordinates),s=L.map(t);L.tileLayer("https://geoappext.nrcan.gc.ca/arcgis/rest/services/BaseMaps/CBMT_CBCT_GEOM_3857/MapServer/WMTS/tile/1.0.0/BaseMaps_CBMT_CBCT_GEOM_3857/default/default028mm/{z}/{y}/{x}.jpg",{attribution:this.labels[this.lang].leafletAttribution}).addTo(s);let r=[{type:"Feature",properties:{id:t,tag:"geoViewGeoJSON"},geometry:{type:"Polygon",coordinates:a}}];console.log(a);let i=L.geoJSON(r);i.addTo(s),s.fitBounds(i.getBounds())}async initializeGeoviewMap(e){let t="map-"+e.id,a=JSON.parse(e.coordinates),s={map:{interaction:"static",viewSettings:{initialView:{zoomAndCenter:[3,[-100,60]]},projection:3978},basemapOptions:{basemapId:"transport",shaded:!1,labeled:!0}},components:["north-arrow"],theme:"geo.ca"};s=JSON.stringify(s),a[0][0]==a[0][a.length-1]&&(console.log(a),a[0].pop()),await cgpv.api.createMapFromConfig(t,s),cgpv.api.maps[t].onMapLayersLoaded(()=>{let e=cgpv.api.maps[t].layer.geometry.addPolygon(a,{style:{strokeColor:"#535aa4",strokeWidth:3,fillColor:"#535aa4",fillOpacity:.2}},void 0,"static").getGeometry().getExtent();cgpv.api.maps[t].zoomToExtent(e)})}renderErrorMessage(){let e=`<div class="geo-featured-data-card__error-message">${this.labels[this.lang].errorMessage}</div>`;this.elements.$results.append(e)}}jQuery(window).on("elementor/frontend/init",e=>{elementorFrontend.elementsHandler.attachHandler("geo-featured-data",GeoFeaturedDataHandler)});